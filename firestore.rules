rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }

    // Treat the account that owns username "admin" as an admin, and also
    // support an explicit custom claim (request.auth.token.admin).
    function adminUidFromUsername() {
      return exists(/databases/$(database)/documents/usernames/admin)
        ? get(/databases/$(database)/documents/usernames/admin).data.uid
        : '';
    }
    function isAdmin() {
      return signedIn() && (request.auth.token.admin == true || request.auth.uid == adminUidFromUsername());
    }

    // ===== user profiles / username registry =====
    match /usernames/{username} {
      allow read: if true;

      // Claim a username once (no overwrites). Username doc id is the normalized username.
      allow create: if signedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.authHandle is string
        && username.matches('^[a-z0-9_]{3,20}$')
        && !exists(/databases/$(database)/documents/usernames/$(username));

      // Registry docs should be immutable after creation. Users may delete their
      // own username doc during account deletion / rename; admins may delete for cleanup.
      allow update: if false;
      allow delete: if isAdmin() || (signedIn() && request.auth.uid == resource.data.uid);
    }

    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create, update: if signedIn() && request.auth.uid == uid;
      allow delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
    }

    // ===== players =====
    match /players/{uid} {
      allow read: if signedIn();
      allow create: if signedIn() && request.auth.uid == uid;
      allow update: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
    }

    // ===== teams =====
    match /teams/{teamId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.creatorUserId == request.auth.uid;
      allow update: if signedIn() && (isAdmin() || resource.data.creatorUserId == request.auth.uid);
      allow delete: if isAdmin();

      match /chat/{msgId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAdmin();
      }
    }

    // ===== global chat =====
    match /globalChat/{msgId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // ===== games (quick play + tournament games) =====
    match /games/{gameId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // ===== presence =====
    match /presence/{uid} {
      allow read: if signedIn();
      allow create, update: if signedIn() && request.auth.uid == uid;
      allow delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
    }

    // ===== direct messages (personal chat) =====
    match /dmThreads/{threadId} {
      allow read: if signedIn() && (request.auth.uid in resource.data.participants);
      allow create: if signedIn()
        && (request.auth.uid in request.resource.data.participants)
        && request.resource.data.participants.size() == 2;
      allow update: if signedIn() && (request.auth.uid in resource.data.participants);
      allow delete: if isAdmin() || (signedIn() && (request.auth.uid in resource.data.participants));

      match /messages/{msgId} {
        allow read: if signedIn()
          && exists(/databases/$(database)/documents/dmThreads/$(threadId))
          && (request.auth.uid in get(/databases/$(database)/documents/dmThreads/$(threadId)).data.participants);
        allow create: if signedIn()
          && exists(/databases/$(database)/documents/dmThreads/$(threadId))
          && (request.auth.uid in get(/databases/$(database)/documents/dmThreads/$(threadId)).data.participants)
          && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if isAdmin();
      }
    }

    // ===== admin backups =====
    match /adminBackups/{backupId} {
      allow read, write: if isAdmin();
      match /{sub=**} {
        allow read, write: if isAdmin();
      }
    }

    // ===== legacy name registry (disabled) =====
    match /nameRegistry/{docId} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
